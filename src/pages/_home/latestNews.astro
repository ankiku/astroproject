---
import NewsCard from "@/components/cards/newsCard.astro";
import HeaderSection from "./headerSection.astro";

const WORKER_URL =
  "https://news-cache-worker.ankitnav1998.workers.dev/news-cache";

/* âœ… Get host dynamically */
let site = Astro.request.headers.get("host");

/* âœ… Normalize local domains â†’ real domain key */
if (
  !site ||
  site.includes("localhost") ||
  site.includes("127.0.0.1") ||
  site.includes("astro.local")
) {
  site = "www.germanyfinanz.news"; // ðŸ‘ˆ backend site key
}

/* âœ… If backend expects full URL, enable this */
// site = `https://${site}`;

const res = await fetch(`${WORKER_URL}?site=${encodeURIComponent(site)}`, {
  headers: { Accept: "application/json" },
});

const data = res.ok ? await res.json() : {};

const articles = (data.articles || []).map((item) => ({
  title: item.title,
  slug: item.slug,
  description: item.content.replace(/<[^>]+>/g, "").slice(0, 160) + "...",
  cover: item.featured_image,
  publishedAt: item.created_at,
}));
---

<section>
  <HeaderSection title="Latest News" />

  {
    articles.length === 0 && (
      <p class="text-center text-gray-500 mt-10">No news available</p>
    )
  }

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {articles.map((article) => <NewsCard article={article} />)}
  </div>
</section>
