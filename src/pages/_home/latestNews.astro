---
import NewsCard from "@/components/cards/newsCard.astro";
import HeaderSection from "./headerSection.astro";

const { site, page = 1, limit = 9 } = Astro.props;

const WORKER_URL =
  "https://news-cache-worker.ankitnav1998.workers.dev/news-cache";

/* ---------- FETCH ---------- */
const res = await fetch(
  `${WORKER_URL}?site=${encodeURIComponent(site)}&page=${page}&limit=${limit}`,
  { headers: { Accept: "application/json" } },
);

if (!res.ok) {
  throw new Error("Failed to fetch news");
}

const data = await res.json();
const articles = data.articles || [];
const totalPages = Number(data.total_pages) || 1;

/* ---------- CLOUDflare LCP IMAGE (PAGE 1 ONLY) ---------- */
const lcpImage =
  page === 1 && articles.length
    ? `/cdn-cgi/image/width=700,quality=80,format=auto/${articles[0].featured_image.replace(
        /^https?:\/\/[^/]+/,
        "",
      )}`
    : null;
---

{/* ✅ Preload EXACT LCP image */}
{
  lcpImage && (
    <link rel="preload" as="image" href={lcpImage} fetchpriority="high" />
  )
}

<section>
  <HeaderSection title="Latest News" />

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {
      articles.map((article, index) => (
        <NewsCard
          article={{
            title: article.title,
            slug: article.slug,
            description:
              article.content?.replace(/<[^>]+>/g, "").slice(0, 160) + "...",
            cover: article.featured_image,
          }}
          index={index}
        />
      ))
    }
  </div>

  {/* ---------- PAGINATION ---------- */}
  {
    totalPages > 1 && (
      <nav class="flex justify-center gap-4 mt-10">
        {page > 1 && (
          <a href={page === 2 ? "/" : `/page/${page - 1}`}>← Previous</a>
        )}

        <span>
          Page {page} of {totalPages}
        </span>

        {page < totalPages && <a href={`/page/${page + 1}`}>Next →</a>}
      </nav>
    )
  }
</section>
