---
export const prerender = false;

import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import NewsCard from "@/components/cards/newsCard.astro";

const { slug } = Astro.params;

/* ---------- WORKER ---------- */
const WORKER_URL = "https://news-cache-worker.ankitnav1998.workers.dev";

/* ---------- DOMAIN ---------- */
let site = Astro.request?.headers.get("host") || "";
if (
  !site ||
  site.includes("localhost") ||
  site.includes("127.0.0.1") ||
  site.includes("astro.local")
) {
  site = "www.germanyfinanz.news";
}

/* ---------- FETCH ARTICLE ---------- */
const articleRes = await fetch(
  `${WORKER_URL}/news-slug?slug=${encodeURIComponent(slug)}`,
  { headers: { Accept: "application/json" } },
);

if (!articleRes.ok) return Astro.redirect("/404");

const article = await articleRes.json();
if (!article?.slug) return Astro.redirect("/404");

/* ---------- META DESCRIPTION (25 WORDS) ---------- */
const stripHtml = (html = "") =>
  html
    .replace(/<[^>]*>/g, " ")
    .replace(/\s+/g, " ")
    .trim();

const metaDescription =
  stripHtml(article.content).split(" ").slice(0, 25).join(" ") || article.title;

/* ---------- FETCH LATEST NEWS ---------- */
const latestRes = await fetch(
  `${WORKER_URL}/news-cache?site=${encodeURIComponent(site)}&limit=6`,
  { headers: { Accept: "application/json" } },
);

const latestData = latestRes.ok ? await latestRes.json() : {};
const latestArticles = (latestData.articles || [])
  .filter((item) => item.slug !== slug)
  .slice(0, 3);
/* ---------- META FOR HEAD ---------- */
const meta = {
  title: article.title,
  metaTitle: article.title,
  description: metaDescription,
  type: "article", // ðŸ”’ THIS is what controls og:type
  ogImage: article.featured_image || "",
  ogImageAlt: article.title,
  publishedTime: article.published_date || new Date().toISOString(),
  lastModified: article.published_date || new Date().toISOString(),
};
---

<BaseLayout meta={meta}>
  <ContentLayout>
    <!-- ARTICLE -->
    <article class="prose prose-lg mx-auto">
      <h1>{article.title}</h1>
      {
        article.featured_image && (
          <img
            src={article.featured_image}
            alt={article.title}
            width="1200"
            height="675"
            class="w-full aspect-video rounded-md object-cover"
            decoding="async"
            loading="eager"
            fetchpriority="high"
          />
        )
      }

      <div class="mt-6" set:html={article.content} />
    </article>

    <!-- RECENT / LATEST NEWS -->
    {
      latestArticles.length > 0 && (
        <section class="mt-16 border-t pt-10">
          <h2 class="text-2xl font-bold mb-6">Latest News</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {latestArticles.map((item, index) => (
              <NewsCard
                article={{
                  title: item.title,
                  slug: item.slug,
                  description: stripHtml(item.content).slice(0, 140) + "...",
                  cover: item.featured_image,
                }}
                index={index}
              />
            ))}
          </div>
        </section>
      )
    }
  </ContentLayout>
</BaseLayout>
