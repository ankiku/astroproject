---
export const prerender = false;

import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import NewsCard from "@/components/cards/newsCard.astro";

const { slug } = Astro.params;

/* ---------- WORKER ---------- */
const WORKER_URL = "https://news-cache-worker.ankitnav1998.workers.dev";

/* ---------- DOMAIN ---------- */
let site = Astro.request?.headers.get("host") || "";
if (!site || site.includes("localhost") || site.includes("astro.local")) {
  site = "www.germanyfinanz.news";
}

/* ---------- FETCH ARTICLE ---------- */
const articleRes = await fetch(
  `${WORKER_URL}/news-slug?slug=${encodeURIComponent(slug)}`,
  { headers: { Accept: "application/json" } },
);

if (!articleRes.ok) {
  return new Response("Not Found", { status: 404 });
}

const article = await articleRes.json();
if (!article?.slug) {
  return new Response("Not Found", { status: 404 });
}

/* ---------- FETCH RELATED ARTICLES ---------- */
let relatedArticles = [];

try {
  const relatedRes = await fetch(
    `${WORKER_URL}/news-cache?site=${encodeURIComponent(site)}&limit=6`,
    { headers: { Accept: "application/json" } },
  );

  const relatedData = relatedRes.ok ? await relatedRes.json() : {};
  relatedArticles = (relatedData.articles || []).filter((a) => a.slug !== slug);
} catch {
  relatedArticles = [];
}

/* ---------- UTIL ---------- */
const stripHtml = (html = "") =>
  html
    .replace(/<[^>]*>/g, " ")
    .replace(/\s+/g, " ")
    .trim();

/* ---------- SORT BY AUTHORITY (OLDER FIRST) ---------- */
const sortedArticles = relatedArticles.sort(
  (a, b) => new Date(a.published_date) - new Date(b.published_date),
);

/* ---------- KEYWORD EXTRACTOR (SAFE) ---------- */
const extractKeywords = (title = "") => {
  const stopWords = new Set([
    "the",
    "when",
    "that",
    "with",
    "from",
    "this",
    "which",
    "your",
    "youre",
    "about",
    "their",
    "there",
    "people",
    "while",
    "where",
    "would",
    "could",
  ]);

  return title
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")
    .split(" ")
    .filter((w) => w.length >= 6 && !stopWords.has(w))
    .slice(0, 3);
};

/* ---------- HTML-SAFE INTERNAL LINKING ---------- */
const advancedInternalLinks = (html = "") => {
  if (!html) return html;

  const MAX_LINKS = 3;
  let used = 0;

  // Split HTML into tags + text nodes
  const parts = html.split(/(<[^>]+>)/g);

  for (let i = 0; i < parts.length; i++) {
    if (used >= MAX_LINKS) break;

    // Skip HTML tags
    if (parts[i].startsWith("<")) continue;

    // Skip if inside anchor
    if (parts[i - 1]?.startsWith("<a")) continue;

    for (const a of sortedArticles) {
      if (used >= MAX_LINKS) break;

      const keywords = extractKeywords(a.title);

      for (const keyword of keywords) {
        if (used >= MAX_LINKS) break;

        const currentHTML = parts.join("");
        if (currentHTML.includes(`href="/${a.slug}"`)) continue;

        const regex = new RegExp(`\\b(${keyword})\\b`, "i");

        if (regex.test(parts[i])) {
          parts[i] = parts[i].replace(
            regex,
            `<a href="/${a.slug}" class="internal-link">$1</a>`,
          );
          used++;
          break;
        }
      }
    }
  }

  return parts.join("");
};

/* ---------- META ---------- */
const meta = {
  title: article.title,
  metaTitle: article.title,
  description:
    stripHtml(article.content).split(" ").slice(0, 25).join(" ") ||
    article.title,
  type: "article",
  ogImage: article.featured_image || "",
  canonical: `https://${site}/${article.slug}`,
  publishedTime: article.published_date,
  lastModified: article.published_date,
};
---

<BaseLayout meta={meta}>
  <ContentLayout>
    <!-- ARTICLE -->
    <article class="prose prose-lg mx-auto">
      <h1>{article.title}</h1>

      {
        article.featured_image && (
          <img
            src={article.featured_image}
            alt={article.title}
            width="1200"
            height="675"
            class="w-full aspect-video rounded-md object-cover"
            loading="eager"
          />
        )
      }

      <!-- âœ… WORKING INTERNAL LINKS -->
      <div class="mt-6" set:html={advancedInternalLinks(article.content)} />
    </article>

    <!-- LATEST NEWS -->
    {
      relatedArticles.length > 0 && (
        <section class="mt-16 border-t pt-10">
          <h2 class="text-2xl font-bold mb-6">Latest News</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {relatedArticles.slice(0, 3).map((item, index) => (
              <NewsCard
                article={{
                  title: item.title,
                  slug: item.slug,
                  description: stripHtml(item.content).slice(0, 140) + "...",
                  cover: item.featured_image,
                }}
                index={index}
              />
            ))}
          </div>
        </section>
      )
    }
  </ContentLayout>
</BaseLayout>
