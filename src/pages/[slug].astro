---
export const prerender = false;

import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import NewsCard from "@/components/cards/newsCard.astro";

const { slug } = Astro.params;

/* ---------- WORKER ---------- */
const WORKER_URL = "https://news-cache-worker.ankitnav1998.workers.dev";

/* ---------- DOMAIN ---------- */
let site = Astro.request?.headers.get("host") || "";
if (
  !site ||
  site.includes("localhost") ||
  site.includes("127.0.0.1") ||
  site.includes("astro.local")
) {
  site = "www.germanyfinanz.news";
}

/* ---------- FETCH ARTICLE ---------- */
const articleRes = await fetch(
  `${WORKER_URL}/news-slug?slug=${encodeURIComponent(slug)}`,
  { headers: { Accept: "application/json" } },
);

if (!articleRes.ok) return Astro.redirect("/302");

const article = await articleRes.json();
if (!article?.slug) return Astro.redirect("/302");

/* ---------- STRIP HTML ---------- */
const stripHtml = (html = "") =>
  html
    .replace(/<[^>]*>/g, " ")
    .replace(/\s+/g, " ")
    .trim();

/* ---------- META DESCRIPTION ---------- */
const metaDescription =
  stripHtml(article.content).split(" ").slice(0, 25).join(" ") || article.title;

/* ---------- FETCH LATEST NEWS ---------- */
const latestRes = await fetch(
  `${WORKER_URL}/news-cache?site=${encodeURIComponent(site)}&limit=6`,
  { headers: { Accept: "application/json" } },
);

const latestData = latestRes.ok ? await latestRes.json() : {};
const latestArticles = (latestData.articles || [])
  .filter((item) => item.slug !== slug)
  .slice(0, 3);

/* ---------- KEYWORD EXTRACTION ---------- */
const extractKeywords = (title = "") => {
  const stopWords = new Set([
    "the",
    "is",
    "are",
    "and",
    "or",
    "to",
    "of",
    "in",
    "for",
    "on",
    "with",
    "a",
    "an",
    "this",
    "that",
    "from",
    "by",
    "as",
    "at",
  ]);

  return title
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")
    .split(" ")
    .filter((word) => word.length >= 4 && !stopWords.has(word))
    .slice(0, 5);
};

/* ---------- AUTO KEYWORD LINKING ---------- */
const autoKeywordLinking = (html = "", articles = [], maxLinks = 3) => {
  if (!html || articles.length === 0) return html;

  let used = 0;
  let output = html;

  for (const article of articles) {
    if (used >= maxLinks) break;

    const keywords = extractKeywords(article.title);

    for (const keyword of keywords) {
      if (used >= maxLinks) break;

      if (output.includes(`href="/${article.slug}"`)) continue;

      const regex = new RegExp(`\\b(${keyword})\\b`, "i");

      if (regex.test(output)) {
        output = output.replace(
          regex,
          `<a href="/${article.slug}" class="internal-link">$1</a>`,
        );
        used++;
        break;
      }
    }
  }

  return output;
};

/* ---------- META ---------- */
const meta = {
  title: article.title,
  metaTitle: article.title,
  description: metaDescription,
  type: "article",
  ogImage: article.featured_image || "",
  ogImageAlt: article.title,
  publishedTime: article.published_date || new Date().toISOString(),
  lastModified: article.published_date || new Date().toISOString(),
};
---

<BaseLayout meta={meta}>
  <ContentLayout>
    <!-- ARTICLE -->
    <article class="prose prose-lg mx-auto">
      <h1>{article.title}</h1>

      {
        article.featured_image && (
          <img
            src={article.featured_image}
            alt={article.title}
            width="1200"
            height="675"
            class="w-full aspect-video rounded-md object-cover"
            decoding="async"
            loading="eager"
            fetchpriority="high"
          />
        )
      }

      <div
        class="mt-6"
        set:html={autoKeywordLinking(article.content, latestArticles)}
      />
    </article>

    <!-- LATEST NEWS -->
    {
      latestArticles.length > 0 && (
        <section class="mt-16 border-t pt-10">
          <h2 class="text-2xl font-bold mb-6">Latest News</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {latestArticles.map((item, index) => (
              <NewsCard
                article={{
                  title: item.title,
                  slug: item.slug,
                  description: stripHtml(item.content).slice(0, 140) + "...",
                  cover: item.featured_image,
                }}
                index={index}
              />
            ))}
          </div>
        </section>
      )
    }
  </ContentLayout>
</BaseLayout>
