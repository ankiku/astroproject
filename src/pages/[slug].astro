---
export const prerender = false;

import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import NewsCard from "@/components/cards/newsCard.astro";

const { slug } = Astro.params;

/* ---------- WORKER ---------- */
const WORKER_URL = "https://news-cache-worker.ankitnav1998.workers.dev";

/* ---------- DOMAIN ---------- */
let site = Astro.request?.headers.get("host") || "";
if (!site || site.includes("localhost") || site.includes("astro.local")) {
  site = "www.germanyfinanz.news";
}

/* ---------- FETCH ARTICLE ---------- */
const articleRes = await fetch(
  `${WORKER_URL}/news-slug?slug=${encodeURIComponent(slug)}`,
  { headers: { Accept: "application/json" } }
);

if (!articleRes.ok) return Astro.redirect("/302");

const article = await articleRes.json();
if (!article?.slug) return Astro.redirect("/302");

/* ---------- FETCH ARTICLES (FOR SILO) ---------- */
const relatedRes = await fetch(
  `${WORKER_URL}/news-cache?site=${encodeURIComponent(site)}&limit=12`,
  { headers: { Accept: "application/json" } }
);

const relatedData = relatedRes.ok ? await relatedRes.json() : {};
const relatedArticles = (relatedData.articles || []).filter(
  (a) => a.slug !== slug
);

/* ---------- UTIL ---------- */
const stripHtml = (html = "") =>
  html.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();

/* ---------- CATEGORY / SILO DETECTION ---------- */
const getSilo = (title = "") => {
  const t = title.toLowerCase();
  if (t.includes("tax")) return "tax";
  if (t.includes("loan") || t.includes("credit")) return "finance";
  if (t.includes("government") || t.includes("policy")) return "policy";
  return "general";
};

const articleSilo = getSilo(article.title);

/* ---------- KEYWORD EXTRACTION ---------- */
const extractKeywords = (title = "") =>
  title
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")
    .split(" ")
    .filter((w) => w.length >= 4)
    .slice(0, 4);

/* ---------- AUTHORITY SORT (OLDER FIRST) ---------- */
const sortedArticles = relatedArticles.sort((a, b) => {
  return new Date(a.published_date) - new Date(b.published_date);
});

/* ---------- ADVANCED INTERNAL LINKING ---------- */
const advancedInternalLinks = (html = "") => {
  if (!html) return html;

  let output = html;
  let linksUsed = 0;
  const MAX_LINKS = 4;

  for (const a of sortedArticles) {
    if (linksUsed >= MAX_LINKS) break;

    // SILO MATCH
    if (getSilo(a.title) !== articleSilo) continue;

    const keywords = extractKeywords(a.title);

    for (const keyword of keywords) {
      if (linksUsed >= MAX_LINKS) break;
      if (output.includes(`href="/${a.slug}"`)) continue;

      const regex = new RegExp(`\\b(${keyword})\\b`, "i");

      if (regex.test(output)) {
        output = output.replace(
          regex,
          `<a href="/${a.slug}" class="internal-link">$1</a>`
        );
        linksUsed++;
        break;
      }
    }
  }

  return output;
};

/* ---------- META ---------- */
const meta = {
  title: article.title,
  metaTitle: article.title,
  description:
    stripHtml(article.content).split(" ").slice(0, 25).join(" ") ||
    article.title,
  type: "article",
  ogImage: article.featured_image || "",
};
---

<BaseLayout meta={meta}>
  <ContentLayout>
    <!-- ARTICLE -->
    <article class="prose prose-lg mx-auto">
      <h1>{article.title}</h1>

      {article.featured_image && (
        <img
          src={article.featured_image}
          alt={article.title}
          width="1200"
          height="675"
          class="w-full aspect-video rounded-md object-cover"
          loading="eager"
        />
      )}

      <!-- ðŸ”¥ ADVANCED SILO INTERNAL LINKS -->
      <div
        class="mt-6"
        set:html={advancedInternalLinks(article.content)}
      />
    </article>

    <!-- LATEST -->
    {relatedArticles.length > 0 && (
      <section class="mt-16 border-t pt-10">
        <h2 class="text-2xl font-bold mb-6">Latest News</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedArticles.slice(0, 3).map((item, index) => (
            <NewsCard
              article={{
                title: item.title,
                slug: item.slug,
                description:
                  stripHtml(item.content).slice(0, 140) + "...",
                cover: item.featured_image,
              }}
              index={index}
            />
          ))}
        </div>
      </section>
    )}
  </ContentLayout>
</BaseLayout>
