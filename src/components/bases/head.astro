---
import "@/styles/global.css";
import type { ArticleMeta, Meta } from "@/lib/types";
import { siteConfig } from "@/lib/siteConfig";

type Props = {
  meta: Meta | ArticleMeta;
};

const { meta } = Astro.props;

/* ---------- URL ---------- */
const url = Astro.request ? new URL(Astro.request.url) : null;
const origin = url?.origin || "";
const pathname = url?.pathname || "/";
const page = Number(url?.searchParams.get("page") || 1);

const canonicalURL = origin
  ? page > 1
    ? `${origin}${pathname}?page=${page}`
    : `${origin}${pathname}`
  : "";

/* ---------- OG IMAGE ---------- */
const OGImage =
  meta.ogImage && origin
    ? meta.ogImage.startsWith("http")
      ? meta.ogImage
      : `${origin}${meta.ogImage}`
    : "";

/* ---------- ANALYTICS ---------- */
const hostname = (url?.hostname || "").replace(/^www\./, "");
const isIP = /^[\d.]+$/.test(hostname);
const site = siteConfig[url?.hostname || ""] || siteConfig[hostname];
const GA_ID = !isIP ? site?.analyticsId : null;

/* ---------- SCHEMA ---------- */
const breadcrumbSchema = canonicalURL
  ? JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: [
        { "@type": "ListItem", position: 1, name: "Home", item: origin },
        {
          "@type": "ListItem",
          position: 2,
          name: meta.title,
          item: canonicalURL,
        },
      ],
    })
  : null;

const articleSchema =
  meta.type === "article" && canonicalURL
    ? JSON.stringify({
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        mainEntityOfPage: {
          "@type": "WebPage",
          "@id": canonicalURL,
        },
        headline: meta.title,
        description: meta.description,
        image: OGImage ? [OGImage] : [],
        datePublished: meta.publishedTime,
        dateModified: meta.lastModified,
        publisher: {
          "@type": "Organization",
          name: site?.name || "The Garden Cafe Cambridge",
          logo: {
            "@type": "ImageObject",
            url: `${origin}/favicon-96x96.png`,
          },
        },
      })
    : null;
---

<head>
  <!-- BASIC -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index, follow, max-image-preview:large" />
  <meta name="googlebot" content="index, follow, max-image-preview:large" />

  <!-- CANONICAL -->
  {canonicalURL && <link rel="canonical" href={canonicalURL} />}

  <!-- SEO -->
  <title>{meta.metaTitle ?? meta.title}</title>
  <meta name="description" content={meta.description} />

  <!-- ðŸ”¤ FONTS (NON-BLOCKING) -->
  <link
    rel="preload"
    href="/_astro/source-serif-4.woff2"
    as="font"
    type="font/woff2"
    crossorigin
  />
  <link
    rel="preload"
    href="/_astro/source-sans-pro-regular.woff2"
    as="font"
    type="font/woff2"
    crossorigin
  />

  <!-- OPEN GRAPH -->
  <meta
    property="og:type"
    content={meta.type === "article" ? "article" : "website"}
  />
  {canonicalURL && <meta property="og:url" content={canonicalURL} />}
  <meta property="og:title" content={meta.title} />
  <meta property="og:description" content={meta.description} />
  {OGImage && <meta property="og:image" content={OGImage} />}

  <!-- ARTICLE DATES -->
  {
    meta.type === "article" && meta.publishedTime && (
      <meta property="article:published_time" content={meta.publishedTime} />
    )
  }
  {
    meta.type === "article" && meta.lastModified && (
      <meta property="article:modified_time" content={meta.lastModified} />
    )
  }

  <!-- TWITTER -->
  <meta name="twitter:card" content="summary_large_image" />
  {canonicalURL && <meta name="twitter:url" content={canonicalURL} />}
  <meta name="twitter:title" content={meta.title} />
  <meta name="twitter:description" content={meta.description} />
  {OGImage && <meta name="twitter:image" content={OGImage} />}

  <!-- SCHEMA -->
  {
    breadcrumbSchema && (
      <script type="application/ld+json" set:html={breadcrumbSchema} />
    )
  }
  {
    articleSchema && (
      <script type="application/ld+json" set:html={articleSchema} />
    )
  }

  <!-- GOOGLE ANALYTICS (DELAYED) -->
  {
    GA_ID && (
      <script is:inline>
        {`
          window.addEventListener('load', () => {
            const s = document.createElement('script');
            s.src = 'https://www.googletagmanager.com/gtag/js?id=${GA_ID}';
            s.async = true;
            document.head.appendChild(s);

            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${GA_ID}');
          });
        `}
      </script>
    )
  }
</head>
